# ä¸‰ç›¸æœº+åŒä¸»æœºæ¢°è‡‚æ•°æ®é‡‡é›†å®Œæ•´æµç¨‹

## ğŸ“‹ ç³»ç»Ÿæ¦‚è¿°

æœ¬ç³»ç»Ÿç”¨äºé‡‡é›†æœºå™¨äººç¤ºæ•™å­¦ä¹ æ•°æ®ï¼ŒåŒ…å«ï¼š
- **3ä¸ªIntel RealSenseç›¸æœº**ï¼ˆå·¦ã€ä¸­ã€å³ï¼‰
- **2ä¸ªPiperä¸»ä»æœºæ¢°è‡‚**ï¼ˆå·¦è‡‚ã€å³è‡‚ï¼‰
- **æ•°æ®æ ¼å¼**ï¼šHDF5ï¼ˆåŒ…å«RGB/æ·±åº¦å›¾åƒã€å…³èŠ‚çŠ¶æ€ã€æœ«ç«¯ä½å§¿ï¼‰

---

## ä¸€ã€ç³»ç»Ÿå‡†å¤‡å’Œæ£€æŸ¥

### 1.1 ç¡¬ä»¶è¿æ¥æ£€æŸ¥

```bash
# æ£€æŸ¥ä¸‰ä¸ªRealSenseç›¸æœºæ˜¯å¦è¿æ¥
rs-enumerate-devices
# åº”è¯¥çœ‹åˆ°ä¸‰ä¸ªç›¸æœºï¼š
# - 401622071599 (å·¦ç›¸æœº)
# - 401622073209 (ä¸­ç›¸æœº)
# - 401522071118 (å³ç›¸æœº)

# æ£€æŸ¥CANè®¾å¤‡
lsusb | grep -i can
# åº”è¯¥çœ‹åˆ°ä¸¤ä¸ªUSBè½¬CANè®¾å¤‡
```

### 1.2 å®‰è£…å¿…è¦ä¾èµ–

```bash
# ROS2ä¾èµ–
sudo apt install ros-humble-realsense2-camera ros-humble-cv-bridge

# CANé€šä¿¡å·¥å…·
sudo apt install can-utils ethtool

# Pythonä¾èµ–
pip3 install h5py dm_env numpy opencv-python
```

---

## äºŒã€é…ç½®CANè®¾å¤‡ï¼ˆåŒè‡‚ï¼‰

**âš ï¸ é‡è¦**ï¼šéœ€è¦ä¸ºå·¦å³ä¸¤ä¸ªæœºæ¢°è‡‚é…ç½®ç‹¬ç«‹çš„CANç«¯å£

### 2.1 é…ç½®æ–¹æ³•

```bash
cd /home/yiqun/code/cobot_magic_ros2/Piper_ros2_humble

# æ–¹æ³•1ï¼šå¦‚æœåªæœ‰ä¸¤ä¸ªCANè®¾å¤‡ï¼Œè‡ªåŠ¨é…ç½®
bash can_activate.sh can_left 1000000
# ç­‰å¾…5ç§’å
bash can_activate.sh can_right 1000000

# æ–¹æ³•2ï¼šå¦‚æœæœ‰å¤šä¸ªCANè®¾å¤‡ï¼Œéœ€è¦æŒ‡å®šUSBç¡¬ä»¶åœ°å€
# å…ˆæŸ¥çœ‹USBåœ°å€
ip -br link show type can
# è®°ä¸‹æ¯ä¸ªCANè®¾å¤‡çš„USBåœ°å€ï¼ˆå¦‚ 1-2:1.0, 1-3:1.0ï¼‰

# ä¸ºå·¦è‡‚é…ç½®ï¼ˆå‡è®¾USBåœ°å€æ˜¯1-2:1.0ï¼‰
bash can_activate.sh can_left 1000000 1-2:1.0

# ä¸ºå³è‡‚é…ç½®ï¼ˆå‡è®¾USBåœ°å€æ˜¯1-3:1.0ï¼‰
bash can_activate.sh can_right 1000000 1-3:1.0
```

### 2.2 éªŒè¯CANè®¾å¤‡é…ç½®

```bash
ip link show type can
# åº”è¯¥çœ‹åˆ°ï¼š
# can_left: <NOARP,UP,LOWER_UP> ... bitrate 1000000
# can_right: <NOARP,UP,LOWER_UP> ... bitrate 1000000
```

---

## ä¸‰ã€å¯åŠ¨ä¸‰ä¸ªç›¸æœº

### 3.1 å¯åŠ¨ç›¸æœºèŠ‚ç‚¹

æ‰“å¼€**ç»ˆç«¯1**ï¼š

```bash
cd /home/yiqun/code/cobot_magic_ros2/camera_ws
source install/setup.bash  # å¦‚æœæ˜¯ROS2
# æˆ–
source devel/setup.bash    # å¦‚æœæ˜¯ROS1

# å¯åŠ¨ä¸‰ä¸ªRealSenseç›¸æœºï¼ˆå·¦ã€ä¸­ã€å³ï¼‰
ros2 launch realsense2_camera multi_camera.launch.py
```

### 3.2 éªŒè¯ç›¸æœºå¯åŠ¨æˆåŠŸ

æ‰“å¼€æ–°ç»ˆç«¯ï¼š

```bash
# æ£€æŸ¥ç›¸æœºè¯é¢˜
ros2 topic list | grep camera

# åº”è¯¥çœ‹åˆ°ï¼š
# /camera_left/color/image_raw
# /camera_left/depth/image_rect_raw
# /camera_middle/color/image_raw
# /camera_middle/depth/image_rect_raw
# /camera_right/color/image_raw
# /camera_right/depth/image_rect_raw

# æ£€æŸ¥å›¾åƒå‘å¸ƒé¢‘ç‡
ros2 topic hz /camera_middle/color/image_raw
# åº”è¯¥æ¥è¿‘ 30 Hz
```

---

## å››ã€å¯åŠ¨åŒä¸»æœºæ¢°è‡‚

### 4.1 å¯åŠ¨æœºæ¢°è‡‚èŠ‚ç‚¹

æ‰“å¼€**ç»ˆç«¯2**ï¼š

```bash
cd /home/yiqun/code/cobot_magic_ros2/Piper_ros2_humble
source install/setup.bash

# å¯åŠ¨åŒä¸»è‡‚ç³»ç»Ÿï¼ˆæ¨¡å¼0ï¼šæ•°æ®é‡‡é›†æ¨¡å¼ï¼‰
ros2 launch piper start_ms_piper.launch.py mode:=0 auto_enable:=false
```

### 4.2 å‚æ•°è¯´æ˜

- `mode:=0` - æ•°æ®é‡‡é›†æ¨¡å¼ï¼Œè¯»å–ä¸»ä»è‡‚å…³èŠ‚çŠ¶æ€
- `auto_enable:=false` - ä¸è‡ªåŠ¨ä¸Šç”µï¼ˆæ›´å®‰å…¨ï¼‰

### 4.3 ç¡¬ä»¶å‡†å¤‡è¦æ±‚

- âœ… ä¸»è‡‚å’Œä»è‡‚é€šè¿‡**èˆªæ’çº¿è¿æ¥**
- âœ… ä»è‡‚ä¼š**è·Ÿéšä¸»è‡‚è¿åŠ¨**ï¼ˆé¥æ“ä½œæ¨¡å¼ï¼‰
- âœ… ç¡®ä¿æœºæ¢°è‡‚å‘¨å›´æœ‰è¶³å¤Ÿçš„æ´»åŠ¨ç©ºé—´

### 4.4 éªŒè¯æœºæ¢°è‡‚å¯åŠ¨æˆåŠŸ

æ‰“å¼€æ–°ç»ˆç«¯ï¼š

```bash
# æ£€æŸ¥æœºæ¢°è‡‚è¯é¢˜
ros2 topic list | grep -E "(master|puppet)"

# åº”è¯¥çœ‹åˆ°ï¼š
# /master/joint_left          # å·¦ä¸»è‡‚å…³èŠ‚çŠ¶æ€
# /master/joint_right         # å³ä¸»è‡‚å…³èŠ‚çŠ¶æ€
# /puppet/joint_left          # å·¦ä»è‡‚å…³èŠ‚çŠ¶æ€
# /puppet/joint_right         # å³ä»è‡‚å…³èŠ‚çŠ¶æ€
# /puppet/end_pose_left       # å·¦ä»è‡‚æœ«ç«¯ä½å§¿
# /puppet/end_pose_right      # å³ä»è‡‚æœ«ç«¯ä½å§¿

# æ£€æŸ¥å…³èŠ‚æ•°æ®å‘å¸ƒé¢‘ç‡
ros2 topic hz /puppet/joint_left
# åº”è¯¥æœ‰æŒç»­çš„æ•°æ®å‘å¸ƒ

# å®æ—¶æŸ¥çœ‹å…³èŠ‚çŠ¶æ€
ros2 topic echo /master/joint_left --once
```

---

## äº”ã€å¯åŠ¨æ•°æ®é‡‡é›†è„šæœ¬

### 5.1 åŸºç¡€é‡‡é›†å‘½ä»¤

æ‰“å¼€**ç»ˆç«¯3**ï¼š

```bash
cd /home/yiqun/code/cobot_magic_ros2

# åŸºç¡€é‡‡é›†å‘½ä»¤ï¼ˆä¿å­˜RGBå›¾åƒï¼‰
python3 collect_data/collect_data.py \
    --dataset_dir ~/robot_data \
    --task_name place_shoe \
    --episode_idx 0 \
    --max_timesteps 500 \
    --arm_type piper \
    --frame_rate 30 \
    --use_depth_image False \
    --use_forward_kinematics True
```

### 5.2 é«˜è´¨é‡é‡‡é›†å‘½ä»¤

```bash
# é«˜è´¨é‡é‡‡é›†ï¼ˆåŒ…å«æ·±åº¦å›¾å’Œè¿åŠ¨å­¦ï¼‰
python3 collect_data/collect_data.py \
    --dataset_dir ~/robot_data \
    --task_name grab_cup \
    --episode_idx 0 \
    --max_timesteps 800 \
    --arm_type piper \
    --frame_rate 30 \
    --use_depth_image True \
    --use_forward_kinematics True
```

### 5.3 å‚æ•°è¯´æ˜

| å‚æ•° | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `--dataset_dir` | æ•°æ®ä¿å­˜ç›®å½•ï¼ˆä¼šè‡ªåŠ¨åˆ›å»ºï¼‰ | `~/robot_data` |
| `--task_name` | ä»»åŠ¡åç§° | `place_shoe` |
| `--episode_idx` | å½“å‰æ•°æ®é›†çš„åºå·ï¼ˆä»0å¼€å§‹ï¼‰ | `0, 1, 2...` |
| `--max_timesteps` | é‡‡é›†çš„æœ€å¤§å¸§æ•° | `500`ï¼ˆçº¦17ç§’@30fpsï¼‰ |
| `--arm_type` | æœºæ¢°è‡‚ç±»å‹ | `piper` |
| `--frame_rate` | é‡‡é›†å¸§ç‡ | `30` |
| `--use_depth_image` | æ˜¯å¦é‡‡é›†æ·±åº¦å›¾ | `True/False` |
| `--use_forward_kinematics` | æ˜¯å¦è®¡ç®—æ­£è¿åŠ¨å­¦å’Œç›¸æœºå¤–å‚ | `True/False` |

### 5.4 é¢„è®¾ä»»åŠ¡åˆ—è¡¨

| ä»»åŠ¡åç§° | ä»»åŠ¡æè¿° |
|---------|---------|
| `place_shoe` | ç”¨ä¸€åªæ‰‹è‡‚æŠ“å–é‹å­å¹¶æ”¾åœ¨å«å­ä¸Š |
| `pick_cup` | æŠ“å–æ¯å­å¹¶æå‡åˆ°ç›®æ ‡é«˜åº¦ |
| `open_door` | æŠ“ä½æŠŠæ‰‹å¹¶æ‹‰å¼€é—¨ |
| `close_drawer` | æŠ“ä½æŠŠæ‰‹å¹¶æ¨åˆ°å®Œå…¨å…³é—­ |
| `wipe_table` | ç”¨æµ·ç»µä»¥åœ†å‘¨è¿åŠ¨æ“¦æ‹­æ ‡è®°åŒºåŸŸ |
| `plug_cable` | æ‹¾èµ·è¿æ¥å™¨å¹¶æ’å…¥æ’åº§ |
| `fold_towel` | æ‹¿èµ·æ¯›å·¾å¹¶æ²¿ä¸­å¿ƒçº¿æŠ˜å  |
| `pour_water` | æŠ“ä½ç“¶å­å¹¶å°†æ°´å€’å…¥æ¯ä¸­ |

---

## å…­ã€æ•°æ®é‡‡é›†è¿‡ç¨‹

### 6.1 é‡‡é›†æµç¨‹

**1. è„šæœ¬å¯åŠ¨å**ï¼Œä¼šæ˜¾ç¤ºï¼š
```
[32må·²åŠ è½½Piperæœºæ¢°è‡‚çš„DHå‚æ•°ï¼ˆ7ä¸ªå…³èŠ‚+æœ«ç«¯ï¼‰[0m
[32mä¸–ç•Œåæ ‡ç³»: å·¦è‡‚åŸºåº§åæ ‡ç³» (base_link)[0m
[32må·¦è‡‚åŸºåº§åç§»: [0. 0. 0.][0m
[32må³è‡‚åŸºåº§åç§»: [ 0.  -0.6  0. ][0m
ç­‰å¾…æ•°æ®åŒæ­¥...
```

**2. åŒæ­¥å®Œæˆå**ï¼Œå¼€å§‹é‡‡é›†ï¼š
```
å¼€å§‹é‡‡é›†æ•°æ®ï¼ˆæŒ‰ Ctrl+C æå‰åœæ­¢ï¼‰
è¿›åº¦: 1/500 å¸§
è¿›åº¦: 2/500 å¸§
...
```

**3. é‡‡é›†è¿‡ç¨‹ä¸­**ï¼š
- æ‰‹åŠ¨æ“æ§**ä¸»è‡‚**æ‰§è¡Œä»»åŠ¡åŠ¨ä½œ
- **ä»è‡‚**ä¼šè‡ªåŠ¨è·Ÿéšä¸»è‡‚è¿åŠ¨
- ä¸‰ä¸ªç›¸æœºåŒæ­¥å½•åˆ¶RGB/æ·±åº¦å›¾åƒ

**4. å®Œæˆé‡‡é›†**ï¼š
```
é‡‡é›†å®Œæˆï¼å…±é‡‡é›† 500 å¸§
æ­£åœ¨ä¿å­˜æ•°æ®åˆ°: /home/yiqun/robot_data/place_shoe/episode_0.hdf5
æ•°æ®å·²æˆåŠŸä¿å­˜ï¼
```

### 6.2 æå‰åœæ­¢

å¦‚éœ€æå‰ç»“æŸé‡‡é›†ï¼ŒæŒ‰ `Ctrl+C`ï¼Œæ•°æ®ä¼šä¿å­˜å·²é‡‡é›†çš„éƒ¨åˆ†ã€‚

---

## ä¸ƒã€æ•°æ®éªŒè¯

### 7.1 æŸ¥çœ‹é‡‡é›†çš„æ•°æ®æ–‡ä»¶

```bash
# æ£€æŸ¥æ•°æ®æ–‡ä»¶
ls -lh ~/robot_data/place_shoe/
# åº”è¯¥çœ‹åˆ°ï¼šepisode_0.hdf5

# æŸ¥çœ‹æ–‡ä»¶å¤§å°
du -h ~/robot_data/place_shoe/episode_0.hdf5
```

### 7.2 æŸ¥çœ‹HDF5æ–‡ä»¶ç»“æ„

```bash
python3 << 'EOF'
import h5py

with h5py.File('~/robot_data/place_shoe/episode_0.hdf5', 'r') as f:
    print("æ•°æ®é›†ç»“æ„ï¼š")
    def print_structure(name, obj):
        print(name)
    f.visititems(print_structure)

    # æŸ¥çœ‹æ•°æ®ç»´åº¦
    print("\næ•°æ®ç»´åº¦ï¼š")
    print(f"å…³èŠ‚ä½ç½®: {f['observations/qpos'].shape}")
    print(f"å·¦ç›¸æœºRGB: {f['observations/camera_left/rgb'].shape}")
    print(f"ä¸­ç›¸æœºRGB: {f['observations/camera_middle/rgb'].shape}")
    print(f"å³ç›¸æœºRGB: {f['observations/camera_right/rgb'].shape}")
    print(f"æ—¶é—´æˆ³: {f['time_stamps'].shape}")

    # æŸ¥çœ‹å…ƒæ•°æ®
    print("\nä»»åŠ¡å…ƒæ•°æ®ï¼š")
    print(f"ä»»åŠ¡åç§°: {f['meta_data/task_name'][()]}")
    print(f"æ€»å¸§æ•°: {f['meta_data/num_steps'][()]}")
EOF
```

### 7.3 æ•°æ®ç»“æ„è¯´æ˜

```
episode_0.hdf5
â”œâ”€â”€ observations/
â”‚   â”œâ”€â”€ qpos [N, 14]              # åŒè‡‚å…³èŠ‚ä½ç½®ï¼ˆæ¯è‡‚6å…³èŠ‚+1å¤¹çˆªï¼‰
â”‚   â”œâ”€â”€ qvel [N, 14]              # åŒè‡‚å…³èŠ‚é€Ÿåº¦
â”‚   â”œâ”€â”€ effort [N, 14]            # åŒè‡‚å…³èŠ‚åŠ›çŸ©
â”‚   â”œâ”€â”€ end_pose_left [N, 7]     # å·¦è‡‚æœ«ç«¯ä½å§¿ï¼ˆxyz + å››å…ƒæ•°ï¼‰
â”‚   â”œâ”€â”€ end_pose_right [N, 7]    # å³è‡‚æœ«ç«¯ä½å§¿
â”‚   â”œâ”€â”€ camera_left/
â”‚   â”‚   â”œâ”€â”€ rgb [N, H, W, 3]     # å·¦ç›¸æœºRGBå›¾åƒ
â”‚   â”‚   â”œâ”€â”€ depth [N, H, W]      # å·¦ç›¸æœºæ·±åº¦å›¾ï¼ˆå¯é€‰ï¼‰
â”‚   â”‚   â”œâ”€â”€ extrinsic [N, 4, 4]  # ç›¸æœºå¤–å‚çŸ©é˜µ
â”‚   â”‚   â””â”€â”€ intrinsic_cv [3, 3]  # ç›¸æœºå†…å‚çŸ©é˜µ
â”‚   â”œâ”€â”€ camera_middle/           # ä¸­ç›¸æœºæ•°æ®ï¼ˆç»“æ„åŒä¸Šï¼‰
â”‚   â””â”€â”€ camera_right/            # å³ç›¸æœºæ•°æ®ï¼ˆç»“æ„åŒä¸Šï¼‰
â”œâ”€â”€ meta_data/
â”‚   â”œâ”€â”€ task_name                # ä»»åŠ¡åç§°
â”‚   â”œâ”€â”€ instruction              # ä»»åŠ¡æè¿°
â”‚   â”œâ”€â”€ user_name                # ç”¨æˆ·å
â”‚   â”œâ”€â”€ uuid                     # å”¯ä¸€æ ‡è¯†ç¬¦
â”‚   â””â”€â”€ num_steps                # æ€»å¸§æ•°
â””â”€â”€ time_stamps [N]              # æ—¶é—´æˆ³åºåˆ—
```

---

## å…«ã€å¤šæ¬¡é‡‡é›†ï¼ˆæ‰¹é‡æ•°æ®é›†ï¼‰

### 8.1 é‡‡é›†å¤šä¸ªepisodeç¤ºä¾‹

```bash
# Episode 0
python3 collect_data/collect_data.py \
    --dataset_dir ~/robot_data \
    --task_name place_shoe \
    --episode_idx 0 \
    --max_timesteps 500

# Episode 1ï¼ˆåŒæ ·çš„ä»»åŠ¡ï¼Œä¸åŒçš„è½¨è¿¹ï¼‰
python3 collect_data/collect_data.py \
    --dataset_dir ~/robot_data \
    --task_name place_shoe \
    --episode_idx 1 \
    --max_timesteps 500

# Episode 2
python3 collect_data/collect_data.py \
    --dataset_dir ~/robot_data \
    --task_name place_shoe \
    --episode_idx 2 \
    --max_timesteps 500
```

### 8.2 æœ€ç»ˆæ•°æ®ç»“æ„

```
~/robot_data/
â”œâ”€â”€ place_shoe/
â”‚   â”œâ”€â”€ episode_0.hdf5
â”‚   â”œâ”€â”€ episode_1.hdf5
â”‚   â””â”€â”€ episode_2.hdf5
â”œâ”€â”€ pick_cup/
â”‚   â”œâ”€â”€ episode_0.hdf5
â”‚   â”œâ”€â”€ episode_1.hdf5
â”‚   â””â”€â”€ episode_2.hdf5
â””â”€â”€ open_door/
    â”œâ”€â”€ episode_0.hdf5
    â””â”€â”€ episode_1.hdf5
```

---

## ä¹ã€å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜1ï¼šç›¸æœºè¯é¢˜ä¸å‘å¸ƒ

**ç—‡çŠ¶**ï¼šè¿è¡Œ `ros2 topic list` çœ‹ä¸åˆ°ç›¸æœºè¯é¢˜

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# 1. æ£€æŸ¥ç›¸æœºè¿æ¥
rs-enumerate-devices

# 2. æ£€æŸ¥USBå¸¦å®½ï¼ˆå¤šä¸ªç›¸æœºå¯èƒ½å¯¼è‡´å¸¦å®½ä¸è¶³ï¼‰
# è§£å†³æ–¹æ¡ˆï¼šé™ä½åˆ†è¾¨ç‡æˆ–å…³é—­æ·±åº¦æµ

# 3. é‡æ–°å¯åŠ¨ç›¸æœºèŠ‚ç‚¹
# æŒ‰ Ctrl+C åœæ­¢ï¼Œç„¶åé‡æ–°å¯åŠ¨
ros2 launch realsense2_camera multi_camera.launch.py
```

### é—®é¢˜2ï¼šæœºæ¢°è‡‚è¯é¢˜æ— æ•°æ®

**ç—‡çŠ¶**ï¼š`ros2 topic hz /puppet/joint_left` æ²¡æœ‰è¾“å‡º

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# 1. æ£€æŸ¥CANè®¾å¤‡çŠ¶æ€
ip link show type can

# 2. æŸ¥çœ‹ROS2èŠ‚ç‚¹å’Œè¯é¢˜
ros2 node list
ros2 topic list

# 3. é‡æ–°é…ç½®CANè®¾å¤‡
bash can_activate.sh can_left 1000000
bash can_activate.sh can_right 1000000

# 4. æ£€æŸ¥èˆªæ’çº¿è¿æ¥æ˜¯å¦æ­£å¸¸
# ç¡®ä¿ä¸»è‡‚å’Œä»è‡‚çš„èˆªæ’çº¿è¿æ¥ç‰¢å›º
```

### é—®é¢˜3ï¼šæ•°æ®åŒæ­¥å¤±è´¥

**ç—‡çŠ¶**ï¼šé‡‡é›†è„šæœ¬æ˜¾ç¤º"ç­‰å¾…æ•°æ®åŒæ­¥..."å¹¶ä¸€ç›´å¡ä½

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# 1. æ£€æŸ¥æ‰€æœ‰è¯é¢˜çš„å‘å¸ƒé¢‘ç‡
ros2 topic hz /camera_middle/color/image_raw
ros2 topic hz /puppet/joint_left
ros2 topic hz /master/joint_left

# 2. ç¡®ä¿æ‰€æœ‰ä¼ æ„Ÿå™¨æ­£å¸¸å‘å¸ƒæ•°æ®
# ç›¸æœºå’Œæœºæ¢°è‡‚è¯é¢˜éƒ½åº”è¯¥æœ‰æ•°æ®

# 3. æ£€æŸ¥é‡‡é›†è„šæœ¬è®¢é˜…çš„è¯é¢˜åç§°æ˜¯å¦æ­£ç¡®
ros2 topic list
```

### é—®é¢˜4ï¼šé‡‡é›†è„šæœ¬æŠ¥é”™

**ç—‡çŠ¶**ï¼šPythonè„šæœ¬å¯åŠ¨å¤±è´¥æˆ–æŠ¥å¯¼å…¥é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# 1. æ£€æŸ¥ROS2ç¯å¢ƒå˜é‡
echo $ROS_DOMAIN_ID
env | grep ROS

# 2. ç¡®ä¿sourcedæ­£ç¡®çš„setup.bash
source /opt/ros/humble/setup.bash
source ~/code/cobot_magic_ros2/Piper_ros2_humble/install/setup.bash

# 3. æ£€æŸ¥Pythonä¾èµ–
pip3 list | grep -E "(h5py|dm_env|numpy|opencv)"

# 4. é‡æ–°å®‰è£…ç¼ºå¤±çš„ä¾èµ–
pip3 install h5py dm_env numpy opencv-python
```

### é—®é¢˜5ï¼šCANè®¾å¤‡å†²çª

**ç—‡çŠ¶**ï¼šè¿è¡Œ `can_activate.sh` æç¤ºæ£€æµ‹åˆ°å¤šä¸ªCANè®¾å¤‡

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# 1. æŸ¥çœ‹æ‰€æœ‰CANè®¾å¤‡å’Œå¯¹åº”çš„USBåœ°å€
for iface in $(ip -br link show type can | awk '{print $1}'); do
    BUS_INFO=$(sudo ethtool -i "$iface" | grep "bus-info" | awk '{print $2}')
    echo "æ¥å£ $iface æ’å…¥åœ¨ USB ç«¯å£ $BUS_INFO"
done

# 2. è®°å½•USBåœ°å€ï¼ˆä¾‹å¦‚ 1-2:1.0 å’Œ 1-3:1.0ï¼‰
# 3. ä½¿ç”¨USBåœ°å€å‚æ•°é…ç½®CANè®¾å¤‡
bash can_activate.sh can_left 1000000 1-2:1.0
bash can_activate.sh can_right 1000000 1-3:1.0
```

---

## åã€å¿«é€Ÿå¯åŠ¨è„šæœ¬ï¼ˆå¯é€‰ï¼‰

### 10.1 åˆ›å»ºè‡ªåŠ¨åŒ–å¯åŠ¨è„šæœ¬

```bash
# åˆ›å»ºå¯åŠ¨è„šæœ¬
cat > ~/start_data_collection.sh << 'EOF'
#!/bin/bash
echo "=== æ•°æ®é‡‡é›†ç³»ç»Ÿå¯åŠ¨ ==="

# é…ç½®CANè®¾å¤‡
cd ~/code/cobot_magic_ros2/Piper_ros2_humble
echo "æ­£åœ¨é…ç½®CANè®¾å¤‡..."
bash can_activate.sh can_left 1000000 &
sleep 2
bash can_activate.sh can_right 1000000

# æ‰“å¼€ç»ˆç«¯å¯åŠ¨ç›¸æœº
echo "å¯åŠ¨ç›¸æœºç³»ç»Ÿ..."
gnome-terminal -- bash -c "
    cd ~/code/cobot_magic_ros2/camera_ws && \
    source install/setup.bash && \
    ros2 launch realsense2_camera multi_camera.launch.py; \
    exec bash"

sleep 5

# æ‰“å¼€ç»ˆç«¯å¯åŠ¨æœºæ¢°è‡‚
echo "å¯åŠ¨æœºæ¢°è‡‚ç³»ç»Ÿ..."
gnome-terminal -- bash -c "
    cd ~/code/cobot_magic_ros2/Piper_ros2_humble && \
    source install/setup.bash && \
    ros2 launch piper start_ms_piper.launch.py mode:=0 auto_enable:=false; \
    exec bash"

echo "=== ç³»ç»Ÿå¯åŠ¨å®Œæˆ ==="
echo ""
echo "è¯·åœ¨æ–°ç»ˆç«¯è¿è¡Œæ•°æ®é‡‡é›†è„šæœ¬ï¼š"
echo "cd ~/code/cobot_magic_ros2"
echo "python3 collect_data/collect_data.py --dataset_dir ~/robot_data --task_name YOUR_TASK --episode_idx 0"
EOF

chmod +x ~/start_data_collection.sh
```

### 10.2 ä½¿ç”¨å¯åŠ¨è„šæœ¬

```bash
# è¿è¡Œå¯åŠ¨è„šæœ¬
~/start_data_collection.sh

# ç­‰å¾…æ‰€æœ‰ç³»ç»Ÿå¯åŠ¨å®Œæˆåï¼Œåœ¨æ–°ç»ˆç«¯è¿è¡Œé‡‡é›†è„šæœ¬
cd ~/code/cobot_magic_ros2
python3 collect_data/collect_data.py \
    --dataset_dir ~/robot_data \
    --task_name place_shoe \
    --episode_idx 0 \
    --max_timesteps 500
```

---

## åä¸€ã€æ ‡å‡†é‡‡é›†æµç¨‹æ€»ç»“

### 11.1 äº”æ­¥é‡‡é›†æµç¨‹

| æ­¥éª¤ | å‘½ä»¤ | è¯´æ˜ |
|------|------|------|
| **1** | `bash can_activate.sh can_left 1000000` | é…ç½®å·¦è‡‚CANè®¾å¤‡ |
| **2** | `bash can_activate.sh can_right 1000000` | é…ç½®å³è‡‚CANè®¾å¤‡ |
| **3** | `ros2 launch realsense2_camera multi_camera.launch.py` | å¯åŠ¨ä¸‰ä¸ªç›¸æœº |
| **4** | `ros2 launch piper start_ms_piper.launch.py mode:=0` | å¯åŠ¨åŒä¸»è‡‚ç³»ç»Ÿ |
| **5** | `python3 collect_data/collect_data.py ...` | å¯åŠ¨æ•°æ®é‡‡é›† |

### 11.2 å…³é”®æ–‡ä»¶ä½ç½®

| åŠŸèƒ½ | æ–‡ä»¶è·¯å¾„ |
|------|---------|
| ç›¸æœºå¯åŠ¨ | `camera_ws/src/realsense-ros/realsense2_camera/launch/multi_camera.launch.py` |
| åŒè‡‚å¯åŠ¨ | `Piper_ros2_humble/src/piper/launch/start_ms_piper.launch.py` |
| æ•°æ®é‡‡é›† | `collect_data/collect_data.py` |
| CANé…ç½® | `Piper_ros2_humble/can_activate.sh` |
| é¡¹ç›®æ–‡æ¡£ | `PROJECT_OVERVIEW.md` |

### 11.3 ç³»ç»Ÿæ¶æ„å›¾

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚    3x RealSenseç›¸æœº     â”‚
                    â”‚ (Left, Middle, Right)   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   collect_data.py       â”‚
                    â”‚  (æ•°æ®é‡‡é›†&åŒæ­¥æ¨¡å—)    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                                 â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  æœºæ¢°è‡‚æ­£è¿åŠ¨å­¦æ¨¡å—    â”‚      â”‚   HDF5æ•°æ®ä¿å­˜æ¨¡å—    â”‚
    â”‚  (RobotKinematics)     â”‚      â”‚  (åŒ…å«å¤–å‚&æ ‡å®š)      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   åŒè‡‚èŠ‚ç‚¹å¯åŠ¨ç³»ç»Ÿ      â”‚
    â”‚  (å·¦è‡‚+å³è‡‚CANé€šä¿¡)     â”‚
    â”‚                        â”‚
    â”œâ”€ piper_left_node       â”‚
    â”‚  (can_left)            â”‚
    â”‚                        â”‚
    â””â”€ piper_right_node      â”‚
       (can_right)           â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## åäºŒã€æ•°æ®é‡‡é›†æœ€ä½³å®è·µ

### 12.1 é‡‡é›†å‰å‡†å¤‡

- [ ] æ£€æŸ¥æ‰€æœ‰ç¡¬ä»¶è¿æ¥ï¼ˆç›¸æœºã€CANè®¾å¤‡ã€èˆªæ’çº¿ï¼‰
- [ ] æ¸…ç†æœºæ¢°è‡‚å·¥ä½œåŒºåŸŸï¼Œç¡®ä¿æ— éšœç¢ç‰©
- [ ] ç¡®è®¤ä»»åŠ¡ç›®æ ‡ç‰©ä½“å·²å‡†å¤‡å¥½
- [ ] æµ‹è¯•æœºæ¢°è‡‚è¿åŠ¨èŒƒå›´ï¼Œé¿å…ç¢°æ’
- [ ] è°ƒæ•´ç›¸æœºä½ç½®å’Œè§’åº¦ï¼Œç¡®ä¿èƒ½æ‹æ‘„åˆ°å®Œæ•´åœºæ™¯

### 12.2 é‡‡é›†è¿‡ç¨‹å»ºè®®

- **åŠ¨ä½œå¹³æ»‘**ï¼šä¸»è‡‚æ“ä½œæ—¶åŠ¨ä½œè¦æµç•…ï¼Œé¿å…çªç„¶çš„åŠ é€Ÿæˆ–å‡é€Ÿ
- **å¤šæ ·æ€§**ï¼šåŒä¸€ä»»åŠ¡é‡‡é›†å¤šä¸ªepisodeæ—¶ï¼Œå°è¯•ä¸åŒçš„èµ·å§‹ä½ç½®å’Œè·¯å¾„
- **å®Œæ•´æ€§**ï¼šç¡®ä¿æ¯ä¸ªepisodeåŒ…å«å®Œæ•´çš„ä»»åŠ¡è¿‡ç¨‹ï¼ˆæŠ“å–â†’ç§»åŠ¨â†’æ”¾ç½®ï¼‰
- **é€Ÿåº¦é€‚ä¸­**ï¼šä¸è¦å¤ªå¿«ï¼ˆæ•°æ®è·Ÿè¸ªå›°éš¾ï¼‰æˆ–å¤ªæ…¢ï¼ˆæ•°æ®å†—ä½™ï¼‰
- **å…‰ç…§ç¨³å®š**ï¼šä¿æŒç¯å¢ƒå…‰ç…§ç¨³å®šï¼Œé¿å…å¼ºå…‰ç›´å°„ç›¸æœº

### 12.3 æ•°æ®è´¨é‡æ£€æŸ¥

æ¯æ¬¡é‡‡é›†åæ£€æŸ¥ï¼š
- HDF5æ–‡ä»¶å¤§å°æ˜¯å¦åˆç†ï¼ˆ500å¸§RGBçº¦200-500MBï¼‰
- å›¾åƒæ˜¯å¦æ¸…æ™°æ— æ¨¡ç³Š
- æœºæ¢°è‡‚è½¨è¿¹æ˜¯å¦å¹³æ»‘è¿ç»­
- æ—¶é—´æˆ³æ˜¯å¦å•è°ƒé€’å¢
- ç›¸æœºå¤–å‚æ˜¯å¦æ­£ç¡®è®¡ç®—

---

## é™„å½•ï¼šå®Œæ•´å‘½ä»¤é€ŸæŸ¥è¡¨

### ç³»ç»Ÿæ£€æŸ¥å‘½ä»¤
```bash
rs-enumerate-devices                    # æ£€æŸ¥ç›¸æœº
lsusb | grep -i can                     # æ£€æŸ¥CANè®¾å¤‡
ip link show type can                   # æŸ¥çœ‹CANçŠ¶æ€
ros2 topic list                         # æŸ¥çœ‹æ‰€æœ‰è¯é¢˜
ros2 topic hz <topic_name>              # æŸ¥çœ‹è¯é¢˜é¢‘ç‡
```

### å¯åŠ¨å‘½ä»¤
```bash
# CANé…ç½®
bash can_activate.sh can_left 1000000
bash can_activate.sh can_right 1000000

# ç›¸æœºå¯åŠ¨
ros2 launch realsense2_camera multi_camera.launch.py

# æœºæ¢°è‡‚å¯åŠ¨
ros2 launch piper start_ms_piper.launch.py mode:=0 auto_enable:=false

# æ•°æ®é‡‡é›†
python3 collect_data/collect_data.py \
    --dataset_dir ~/robot_data \
    --task_name place_shoe \
    --episode_idx 0 \
    --max_timesteps 500
```

### æ•…éšœæ’æŸ¥å‘½ä»¤
```bash
# é‡å¯ROS2å®ˆæŠ¤è¿›ç¨‹
ros2 daemon stop && ros2 daemon start

# æŸ¥çœ‹èŠ‚ç‚¹æ—¥å¿—
ros2 node list
ros2 node info <node_name>

# æŸ¥çœ‹è¯é¢˜è¯¦æƒ…
ros2 topic info <topic_name>
ros2 topic echo <topic_name> --once

# æ£€æŸ¥TFå˜æ¢
ros2 run tf2_tools view_frames
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2026-02-02
**ç»´æŠ¤è€…**: Yiqun
**é¡¹ç›®è·¯å¾„**: `/home/yiqun/code/cobot_magic_ros2`
